rules_version = '2';

service cloud.firestore {

  match /databases/{database}/documents {
    
    // Helper function to check if a user is an admin
    function isAdmin(userId) {
      return get(/databases/$(database)/documents/artifacts/default-app-id/users/$(userId)).data.isAdmin == true;
    }

    // Helper function to check if user is authenticated and not anonymous
    function isAuthenticated() {
      return request.auth != null && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    // --- 1. USER DATA RULES ---
    
    // This rule matches the COLLECTION 'users'
    match /artifacts/{appId}/users {
      // An admin can LIST the entire collection
      allow list: if request.auth != null && isAdmin(request.auth.uid);
    }

    // This rule matches a specific DOCUMENT 'users/{userId}'
    match /artifacts/{appId}/users/{userId} {
      // An admin can READ or WRITE to any single user document
      allow read, write: if request.auth != null && isAdmin(request.auth.uid);
      
      // A user can READ their *own* document
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // A user can CREATE their own document (for new signups)
      // This handles set() operations when document doesn't exist
      allow create: if request.auth != null 
                    && request.auth.uid == userId
                    // Only allow setting isAdmin/isPremium to false on creation
                    && (!('isAdmin' in request.resource.data) || request.resource.data.isAdmin == false)
                    && (!('isPremium' in request.resource.data) || request.resource.data.isPremium == false);
      
      // A user can UPDATE their own document
      // This handles update() operations - explicitly allows photoURL
      allow update: if request.auth != null && request.auth.uid == userId
                    // Protects against users making themselves admin/premium
                    && !('isAdmin' in request.resource.data)
                    && !('isPremium' in request.resource.data)
                    // Only allow specific fields to be updated
                    && request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['displayName', 'birthday', 'lastUpdated', 'email', 'photoURL']);
      
      // A user can WRITE (set with merge) their own document
      // This is needed because set() with merge is treated as write, not update
      allow write: if request.auth != null && request.auth.uid == userId
                   // Prevent users from setting isAdmin to true
                   && (!('isAdmin' in request.resource.data) || request.resource.data.isAdmin == false)
                   // Prevent users from changing isPremium (must match existing or not be set)
                   && (!('isPremium' in request.resource.data) 
                        || (resource == null && request.resource.data.isPremium == false)
                        || (resource != null && resource.data.isPremium == request.resource.data.isPremium));
    }

    // This rule matches all SUBCOLLECTIONS of a user (watchlist, etc.)
    match /artifacts/{appId}/users/{userId}/{document=**} {
      // A user can read/write their *own* subcollections
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // An admin can also read/write to any user's subcollections
      allow read, write: if request.auth != null && isAdmin(request.auth.uid);
    }

    // --- 2. PUBLIC MOVIE DATA ---
    
    // Movie documents (main movie data)
    match /artifacts/{appId}/movies/{movieId} {
      // Anyone can read movie data
      allow read: if true;
      // Only admins can write movie data (full document)
      allow write: if request.auth != null && isAdmin(request.auth.uid);
      
      // Allow authenticated users to create movie document with only likeCount
      // This is needed when a movie document doesn't exist yet
      allow create: if isAuthenticated()
                    && request.resource.data.keys().hasOnly(['likeCount']);
      
      // Allow authenticated users to update only the likeCount field
      // This is needed for the likes functionality
      allow update: if isAuthenticated()
                    && request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['likeCount']);
    }

    // Movie likes subcollection
    match /artifacts/{appId}/movies/{movieId}/likes/{userId} {
      // Anyone can read likes (for displaying like counts)
      allow read: if true;
      // Only the authenticated user can write their own like
      allow write: if request.auth != null 
                   && request.auth.uid == userId
                   && request.auth.token.firebase.sign_in_provider != 'anonymous';
    }

    // Movie comments subcollection
    match /artifacts/{appId}/movies/{movieId}/comments/{commentId} {
      // Anyone can read comments
      allow read: if true;
      // Authenticated (non-anonymous) users can create comments
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;
      // Users can update their own comments (if needed in future)
      allow update: if isAuthenticated()
                    && request.auth.uid == resource.data.userId;
      // Users can delete their own comments OR admins can delete any comment
      allow delete: if isAuthenticated() 
                    && (request.auth.uid == resource.data.userId || isAdmin(request.auth.uid));
    }

    // --- 3. DEFAULT DENY RULE ---
    // Any other path is denied by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
